<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TRADEco - Factura/Comprobante</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    @media print {
      .no-print {
        display: none !important;
      }
      body {
        background: white !important;
      }
      .invoice-container {
        box-shadow: none !important;
        margin: 0 !important;
      }
    }

    .invoice-container {
      max-width: 800px;
      margin: 2rem auto;
      background: white;
      padding: 3rem;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }

    .invoice-header {
      border-bottom: 3px solid #198754;
      padding-bottom: 2rem;
      margin-bottom: 2rem;
    }

    .invoice-footer {
      border-top: 2px solid #e0e0e0;
      padding-top: 2rem;
      margin-top: 3rem;
      text-align: center;
      color: #666;
    }

    .invoice-section {
      margin-bottom: 2rem;
    }

    .invoice-table {
      width: 100%;
      margin-top: 1rem;
    }

    .invoice-table th {
      background-color: #f8f9fa;
      padding: 0.75rem;
      text-align: left;
      border-bottom: 2px solid #dee2e6;
    }

    .invoice-table td {
      padding: 0.75rem;
      border-bottom: 1px solid #dee2e6;
    }

    .total-section {
      background-color: #f8f9fa;
      padding: 1.5rem;
      border-radius: 8px;
      margin-top: 2rem;
    }

    .status-badge {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body style="background-color: #f5f5f5;">

  <!-- BOTONES DE ACCIÓN (No se imprimen) -->
  <div class="container mt-3 no-print">
    <div class="d-flex justify-content-between align-items-center">
      <a href="transaccion.html?id=" id="backBtn" class="btn btn-outline-success">
        <i class="bi bi-arrow-left"></i> Volver
      </a>
      <div>
        <button onclick="window.print()" class="btn btn-success me-2">
          <i class="bi bi-printer"></i> Imprimir
        </button>
        <button onclick="downloadPDF()" class="btn btn-primary">
          <i class="bi bi-download"></i> Descargar PDF
        </button>
      </div>
    </div>
  </div>

  <!-- SPINNER DE CARGA -->
  <div id="loadingSpinner" class="text-center py-5">
    <div class="spinner-border text-success" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-2 text-muted">Generando comprobante...</p>
  </div>

  <!-- CONTENEDOR DE LA FACTURA -->
  <div id="invoiceContainer" class="invoice-container" style="display: none;">
    
    <!-- HEADER -->
    <div class="invoice-header">
      <div class="row">
        <div class="col-md-6">
          <h1 class="text-success mb-0">
            <i class="bi bi-tshirt"></i> TRADEco
          </h1>
          <p class="text-muted mb-0">Moda Circular & Sustentable</p>
        </div>
        <div class="col-md-6 text-md-end">
          <h2 class="text-success mb-3">COMPROBANTE</h2>
          <p class="mb-1"><strong>Código:</strong> <span id="invoiceCode" class="text-success"></span></p>
          <p class="mb-1"><strong>Fecha:</strong> <span id="invoiceDate"></span></p>
          <div id="invoiceStatus" class="mt-2"></div>
        </div>
      </div>
    </div>

    <!-- DATOS DE LAS PARTES -->
    <div class="row invoice-section">
      <div class="col-md-6">
        <h5 class="text-success mb-3">
          <i class="bi bi-cart-check"></i> COMPRADOR
        </h5>
        <p class="mb-1"><strong>Nombre:</strong> <span id="buyerName"></span></p>
        <p class="mb-1"><strong>Usuario:</strong> <span id="buyerUsername"></span></p>
      </div>
      <div class="col-md-6">
        <h5 class="text-success mb-3">
          <i class="bi bi-shop"></i> VENDEDOR
        </h5>
        <p class="mb-1"><strong>Nombre:</strong> <span id="sellerName"></span></p>
        <p class="mb-1"><strong>Usuario:</strong> <span id="sellerUsername"></span></p>
        <p class="mb-1"><strong>WhatsApp:</strong> <span id="sellerWhatsapp"></span></p>
      </div>
    </div>

    <!-- DETALLES DEL PRODUCTO -->
    <div class="invoice-section">
      <h5 class="text-success mb-3">
        <i class="bi bi-box-seam"></i> DETALLE DE LA TRANSACCIÓN
      </h5>
      
      <table class="invoice-table">
        <thead>
          <tr>
            <th style="width: 50%;">Producto</th>
            <th style="width: 15%;">Talla</th>
            <th style="width: 20%;">Categoría</th>
            <th style="width: 15%; text-align: right;">Precio</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <strong id="productName"></strong>
              <br>
              <small class="text-muted" id="productDescription"></small>
            </td>
            <td id="productSize"></td>
            <td>
              <span class="badge bg-success" id="productCategory"></span>
            </td>
            <td style="text-align: right;">
              <strong id="productPrice"></strong>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- MÉTODO DE PAGO -->
    <div class="invoice-section">
      <div class="row">
        <div class="col-md-6">
          <h6 class="text-success">Método de Pago</h6>
          <p id="paymentMethod" class="mb-0"></p>
        </div>
        <div class="col-md-6">
          <h6 class="text-success">Fecha de Completado</h6>
          <p id="completedDate" class="mb-0"></p>
        </div>
      </div>
    </div>

    <!-- TOTAL -->
    <div class="total-section">
      <div class="row">
        <div class="col-md-8">
          <h5 class="mb-0">TOTAL</h5>
        </div>
        <div class="col-md-4 text-end">
          <h4 class="text-success mb-0" id="totalAmount"></h4>
        </div>
      </div>
    </div>

    <!-- TIMELINE (OPCIONAL) -->
    <div class="invoice-section">
      <h6 class="text-success mb-3">Historial de la Transacción</h6>
      <div id="timelineList" style="font-size: 0.9rem;">
        <!-- Se llenará dinámicamente -->
      </div>
    </div>

    <!-- FOOTER -->
    <div class="invoice-footer">
      <p class="mb-2">
        <strong>TRADEco - Plataforma de Moda Circular</strong>
      </p>
      <p class="mb-0" style="font-size: 0.85rem;">
        Este comprobante certifica la transacción realizada entre las partes mencionadas.
      </p>
      <p class="mb-0" style="font-size: 0.85rem;">
        🌱 Contribuyendo a un futuro más sustentable
      </p>
      <p class="mt-3 mb-0" style="font-size: 0.75rem; color: #999;">
        Código de transacción: <span id="footerCode"></span> | Generado el: <span id="generatedDate"></span>
      </p>
    </div>

  </div>

  <!-- MENSAJE DE ERROR -->
  <div id="errorContainer" class="text-center py-5" style="display: none;">
    <i class="bi bi-exclamation-triangle fs-1 text-warning"></i>
    <h3 class="mt-3">No se pudo generar el comprobante</h3>
    <p class="text-muted">La transacción no existe o no está completada.</p>
    <a href="mis-transacciones.html" class="btn btn-success mt-3">
      <i class="bi bi-arrow-left"></i> Ver mis transacciones
    </a>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="api.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <script>
    // Obtener ID de la transacción
    const urlParams = new URLSearchParams(window.location.search);
    const transactionId = urlParams.get('id');

    // Cargar y mostrar factura
    async function loadInvoice() {
      if (!transactionId) {
        showError();
        return;
      }

      try {
        const result = await getTransaction(transactionId);
        
        document.getElementById('loadingSpinner').style.display = 'none';
        
        if (!result.success || !result.data) {
          showError();
          return;
        }

        const transaction = result.data;

        // Verificar que esté completada
        if (transaction.status !== 'completada') {
          showError();
          return;
        }

        // Mostrar factura
        document.getElementById('invoiceContainer').style.display = 'block';

        // Actualizar botón de volver
        document.getElementById('backBtn').href = `transaccion.html?id=${transactionId}`;

        // Header
        document.getElementById('invoiceCode').textContent = transaction.transaction_code;
        document.getElementById('invoiceDate').textContent = formatDate(transaction.created_at);
        document.getElementById('invoiceStatus').innerHTML = '<span class="status-badge" style="background-color: #198754; color: white;">COMPLETADA</span>';

        // Partes
        document.getElementById('buyerName').textContent = transaction.buyer.nombre;
        document.getElementById('buyerUsername').textContent = `@${transaction.buyer.username}`;
        document.getElementById('sellerName').textContent = transaction.seller.nombre;
        document.getElementById('sellerUsername').textContent = `@${transaction.seller.username}`;
        document.getElementById('sellerWhatsapp').textContent = transaction.seller.whatsapp || 'No especificado';

        // Producto
        const product = transaction.product_snapshot;
        document.getElementById('productName').textContent = product.nombre;
        document.getElementById('productDescription').textContent = product.descripcion;
        document.getElementById('productSize').textContent = product.talla;
        document.getElementById('productCategory').textContent = product.categoria;
        document.getElementById('productPrice').textContent = `$${product.precio.toLocaleString('es-AR')}`;

        // Método de pago
        document.getElementById('paymentMethod').textContent = transaction.payment_method || 'No especificado';
        document.getElementById('completedDate').textContent = formatDate(transaction.completed_at);

        // Total
        document.getElementById('totalAmount').textContent = `$${product.precio.toLocaleString('es-AR')}`;

        // Timeline
        const timelineDiv = document.getElementById('timelineList');
        transaction.timeline.forEach((event, index) => {
          timelineDiv.innerHTML += `
            <p class="mb-1">
              <i class="bi bi-check-circle-fill text-success"></i>
              <strong>${event.message}</strong> - 
              <small class="text-muted">${formatDate(event.timestamp)}</small>
            </p>
          `;
        });

        // Footer
        document.getElementById('footerCode').textContent = transaction.transaction_code;
        document.getElementById('generatedDate').textContent = new Date().toLocaleDateString('es-AR');

        // Actualizar título
        document.title = `Factura ${transaction.transaction_code} - TRADEco`;

      } catch (error) {
        document.getElementById('loadingSpinner').style.display = 'none';
        showError();
      }
    }

    function showError() {
      document.getElementById('loadingSpinner').style.display = 'none';
      document.getElementById('invoiceContainer').style.display = 'none';
      document.getElementById('errorContainer').style.display = 'block';
    }

    // Formatear fecha
    function formatDate(isoString) {
      if (!isoString) return 'N/A';
      const date = new Date(isoString);
      return date.toLocaleDateString('es-AR', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Descargar PDF
    function downloadPDF() {
      const element = document.getElementById('invoiceContainer');
      const transactionCode = document.getElementById('invoiceCode').textContent;
      
      const opt = {
        margin: 10,
        filename: `Factura_${transactionCode}_TRADEco.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      html2pdf().set(opt).from(element).save();
      
      showAlert('Descargando factura...', 'success');
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', loadInvoice);
  </script>
</body>
</html>